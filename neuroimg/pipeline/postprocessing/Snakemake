import os
import sys
sys.path.append("../../../")
from neuroimg.pipeline.fileutils import SCRIPTS_UTIL_DIR
from neuroimg.pipeline.fileutils import get_freesurfer_patient_dir, get_freesurfer_dir, \
    get_rawct_dir, get_rawmri_dir, get_rawacpc_dir


configfile: "../config/localconfig.yaml"

# get the freesurfer patient directory
FS_OUTPUT_DIR = get_freesurfer_dir(config)
FS_PATIENT_OUTPUT_DIR = get_freesurfer_patient_dir(config)
RAW_CT_FOLDER = get_rawct_dir(config)
RAW_MRI_FOLDER = get_rawmri_dir(config)
RAW_MRIACPC_FOLDER = get_rawacpc_dir(config)

FSOUT_MRI_FOLDER = os.path.join(FS_PATIENT_OUTPUT_DIR, "mri")
FSOUT_CT_FOLDER = os.path.join(FS_PATIENT_OUTPUT_DIR, "CT")
FSOUT_ELECS_FOLDER = os.path.join(FS_PATIENT_OUTPUT_DIR, "elecs")
FSOUT_ACPC_FOLDER = os.path.join(FS_PATIENT_OUTPUT_DIR, "acpc")
FSOUT_SURF_FOLDER = os.path.join(FS_PATIENT_OUTPUT_DIR, "surf")

# First rule
rule all:
    input:
        outsuccess_file=expand(os.path.join(FS_PATIENT_OUTPUT_DIR, "{patient_id}_recon_success.txt"),
                               patient_id=config['patients']),
        brainmask_nifti = expand(os.path.join(FSOUT_MRI_FOLDER, "brainmask.nii.gz"),
                               patient_id=config['patients']),
        lhpial = expand(os.path.join(FSOUT_SURF_FOLDER, "ascii", "lh.pial.asc"),
                                patient_id=config['patients']),
        rhpial = expand(os.path.join(FSOUT_SURF_FOLDER, "ascii", "rh.pial.asc"),
                                patient_id=config['patients']),
        subcort_success_flag_file = expand(os.path.join(FS_PATIENT_OUTPUT_DIR, "{patient_id}_subcort_success.txt"),
                                patient_id=config['patients']),
        MRI_NIFTI_IMG = expand(os.path.join(FSOUT_MRI_FOLDER, "origT1.nii"),
                               patient_id=config['patients']),
    shell:
        "echo 'done'"


"""
Maps a MRI T1 Image result to a corresponding Atlas template, such as MNI, or FSAverage.

"""
rule map_t1img_to_atlas:
    input:

    params:
        fs_subj_dir = os.path.join(FS_PATIENT_OUTPUT_DIR),
        MRI_FOLDER=RAW_MRI_FOLDER,
        INPUT_FS_ORIG_DIR = os.path.join(FSOUT_MRI_FOLDER, "orig"),
        MRI_MGZ_IMG=os.path.join(FSOUT_MRI_FOLDER, "orig", "001.mgz"),
    output:
        # CT_NIFTI_IMG=os.path.join(FSOUT_CT_FOLDER, "CT.nii"),
        # MRI_NIFTI_IMG = os.path.join(FS_PATIENT_OUTPUT_DIR, "mri", "origT1.nii")
    shell:
        "mrconvert {params.CT_FOLDER} {output.CT_NIFTI_IMG};"
        "mrconvert {params.MRI_FOLDER} {params.MRI_MGZ_IMG}; "
        "mrconvert {params.MRI_MGZ_IMG} {output.MRI_NIFTI_IMG};"

rule summarize_statistics_from_freesurfer:
    input:

    params:

    output:

    shell: